name: CI
on:
  push:
    # branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  HOST: localhost
  DATABASE: vetlog
  # Epehemeral credentials for testing
  DB_ROOT_PASSWORD: root_secret
  VETLOG_USER: vetlogUser
  VETLOG_PASSWORD: vetlogDB
  FACTOR: ${{ secrets.FACTOR || '0.5' }}

jobs:
  build:
    runs-on: ubuntu-latest

    # 1. Define MySQL as a service container
    services:
      mysql:
        image: mysql:8.0
        env:
          # Automatically set up the root password
          MYSQL_ROOT_PASSWORD: root_secret
          # Automatically create the database and user for the application
          MYSQL_DATABASE: vetlog
          MYSQL_USER: vetlogUser
          MYSQL_PASSWORD: vetlogDB
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Check out repository code
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0
        with:
          # Fetch depth 0 is important for SonarQube to get full history
          fetch-depth: 0

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.3.0
        with:
          python-version: "3.12.3"

      # # Ensure mysql client is available for the setup step
      # - name: Install MySQL client
      #   run: sudo apt-get update && sudo apt-get install -y default-mysql-client

      - name: Install with uv
        run: |
          pip install uv
          uv sync

      - name: Format with ruff
        run: |
          uv run ruff check

      # 2. Database Setup: Wait for service and execute SQL
      - name: Wait for MySQL and initialize database
        env:
          # Use ephemeral credentials defined in global env
          MYSQL_PWD: ${{ env.DB_ROOT_PASSWORD }}
        run: |
          # Wait for MySQL service to be available
          echo "Waiting for MySQL service to start on $HOST:3306..."
          for i in $(seq 1 10); do
            nc -z -w 5 $HOST 3306 && break
            echo "Attempt $i failed. Retrying in 5 seconds..."
            sleep 5
          done

      - name: Load schema and data from init.sql into database
        run: |
          # Execute the extracted SQL script
          mysql -h $HOST -uroot -D${DATABASE} < init.sql

      - name: Execute tests
        run: |
          source ${{ github.workspace }}/.venv/bin/activate
          python -m unittest discover ${{ github.workspace }} -s tests

      - name: Run tests with coverage
        run: |
          source ${{ github.workspace }}/.venv/bin/activate
          coverage run -m unittest discover
          coverage report -m
          coverage html
          coverage xml

      - name: Archive code coverage results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: code-coverage-report
          path: htmlcov
          retention-days: 30

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
        env:
          # Needed to get PR information, if any
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # Links Sonar project to GitHub commit hash
          args: >
            -Dsonar.projectVersion=${{ github.sha }}
